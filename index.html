<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reconhecimento Facial — PSS (GitHub Pages + GAS API)</title>
<style>
  body{margin:0;font:500 15px/1.5 system-ui,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:#94a3b8;font-size:13px;margin-bottom:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:320px}
  label{display:block;font-size:13px;color:#cbd5e1;margin:10px 0 4px}
  input,select{width:100%;padding:10px;border:1px solid #334155;border-radius:10px;background:#0b1220;color:#e5e7eb}
  button{padding:10px 14px;border:0;border-radius:12px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
  button.alt{background:#0ea5e9}
  .ok{color:#10b981;margin-left:8px}
  .err{color:#f43f5e}
  video,canvas{width:100%;border-radius:14px;background:#111827;min-height:240px}
  .status{margin-top:10px;font-size:14px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#111827;border:1px solid #1f2937;color:#e5e7eb;font-size:12px}
  .log{white-space:pre-wrap;font-size:12px;background:#0b1120;border:1px solid #1f2a44;border-radius:10px;padding:10px;max-height:180px;overflow:auto}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Reconhecimento Facial — Portal SimonSports</h1>
      <div class="muted">Front no GitHub Pages + API no Apps Script (Planilhas + Drive). Clique <b>Ativar câmera</b>.</div>

      <div class="row">
        <div class="col">
          <h2>Cadastro</h2>
          <label>Nome completo</label>
          <input id="nome" placeholder="Nome completo" />
          <div class="row">
            <div class="col"><label>RG</label><input id="rg" placeholder="RG" /></div>
            <div class="col"><label>CPF</label><input id="cpf" placeholder="CPF" /></div>
          </div>
          <label>CIN</label><input id="cin" placeholder="CIN" />
          <div class="row" style="margin-top:10px;align-items:center">
            <div class="col">
              <button id="btnStart" class="alt">Ativar câmera</button>
              <button id="btnFoto">Capturar foto + salvar</button>
            </div>
            <div class="col">
              <label>Dispositivo de vídeo</label>
              <select id="deviceSelect"></select>
            </div>
          </div>
          <div class="status" id="cadStatus"></div>
        </div>

        <div class="col">
          <h2>Câmera</h2>
          <video id="video" playsinline muted></video>
          <canvas id="photo" style="display:none"></canvas>
          <div class="status"><span class="pill" id="modelStatus">Carregando modelos…</span></div>
        </div>
      </div>

      <hr style="border-color:#1f2a44;margin:18px 0"/>

      <div class="row">
        <div class="col">
          <h2>Reconhecimento (ao vivo)</h2>
          <div class="muted">Deixe a tela aberta. Ao identificar, mostra o nome.</div>
          <div class="status" id="recStatus">Aguardando ativação da câmera…</div>
          <div class="status" id="matchStatus"></div>
        </div>
        <div class="col">
          <h2>Logs</h2>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const GAS_API_URL = 'https://script.google.com/macros/s/COLE_AQUI_URL_DO_SEU_DEPLOY/exec'; // ← TROQUE POR SUA URL
const state = { embeddingsBase: [], running: false, lastMatch: '', stream: null };

function log(msg){ const el = document.getElementById('log'); el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; el.scrollTop = el.scrollHeight; }

async function loadModels() {
  const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
  ]);
  document.getElementById('modelStatus').textContent = 'Modelos prontos';
  log('Modelos carregados.');
}

async function listDevices() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    const sel = document.getElementById('deviceSelect');
    sel.innerHTML = '';
    cams.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.deviceId; opt.textContent = c.label || `Câmera ${sel.length+1}`;
      sel.appendChild(opt);
    });
    if (!cams.length) log('Nenhuma câmera encontrada.');
  } catch (e) { log('enumerateDevices: ' + e.message); }
}

async function startCamera(deviceId) {
  if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); state.stream = null; }
  const constraints = deviceId ? { video: { deviceId: { exact: deviceId } }, audio: false }
                               : { video: { facingMode: 'user' }, audio: false };
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = document.getElementById('video');
    video.srcObject = stream;
    state.stream = stream;
    await new Promise(res => video.onloadedmetadata = () => { video.play(); res(); });
    document.getElementById('recStatus').textContent = 'Câmera ativa, iniciando reconhecimento…';
    log('Câmera iniciada.');
    if (!state.running) recognitionLoop();
    await listDevices();
  } catch (e) {
    document.getElementById('recStatus').innerHTML = `<span class="err">Falha ao iniciar câmera: ${e.name||''} ${e.message||e}</span>`;
    log('getUserMedia erro: ' + (e.name||'') + ' ' + (e.message||e));
  }
}

function takeSnapshot() {
  const video = document.getElementById('video');
  if (!video.videoWidth) throw new Error('Vídeo não carregado.');
  const canvas = document.getElementById('photo');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/jpeg', 0.9);
}

async function computeEmbeddingFromVideo() {
  const video = document.getElementById('video');
  const det = await faceapi
     .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
     .withFaceLandmarks()
     .withFaceDescriptor();
  if (!det) return null;
  return Array.from(det.descriptor);
}

function cosineSimilarity(a, b) {
  if (!a || !b || a.length !== b.length) return -1;
  let dot=0, na=0, nb=0;
  for (let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
  return dot / (Math.sqrt(na)*Math.sqrt(nb));
}

async function fetchEmbeddings() {
  const r = await fetch(`${GAS_API_URL}?fn=list`, { method:'GET', credentials:'omit' });
  const j = await r.json();
  if (!j.ok) throw new Error(j.error||'Falha ao listar');
  state.embeddingsBase = j.data || [];
  log(`Embeddings carregados: ${state.embeddingsBase.length}`);
}

async function saveCadastro(payload) {
  const r = await fetch(`${GAS_API_URL}?fn=save`, {
    method:'POST', headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(payload), credentials:'omit'
  });
  const j = await r.json();
  if (!j.ok) throw new Error(j.error||'Falha ao salvar');
  return j;
}

async function recognitionLoop() {
  if (state.running) return;
  state.running = true;
  const recStatus = document.getElementById('recStatus');
  const matchStatus = document.getElementById('matchStatus');

  while (state.running) {
    try {
      const emb = await computeEmbeddingFromVideo();
      if (emb) {
        let best = { name: 'Desconhecido', score: -1 };
        for (const p of state.embeddingsBase) {
          const s = cosineSimilarity(emb, p.embedding);
          if (s > best.score) best = { name: p.nome, score: s };
        }
        if (best.score >= 0.58 && best.name !== state.lastMatch) {
          state.lastMatch = best.name;
          matchStatus.innerHTML = `<span class="ok">Reconhecimento realizado:</span> <b>${best.name}</b> (sim=${best.score.toFixed(2)})`;
          log(`Match: ${best.name} (sim=${best.score.toFixed(3)})`);
        } else if (best.score < 0.58) {
          matchStatus.textContent = 'Sem correspondência confiável no momento…';
        }
        recStatus.textContent = 'Rodando…';
      } else {
        recStatus.textContent = 'Rosto não detectado…';
      }
    } catch(e) {
      matchStatus.innerHTML = `<span class="err">Erro no reconhecimento: ${e.message}</span>`;
      log('Reconhecimento erro: ' + e.message);
    }
    await new Promise(r => setTimeout(r, 600));
  }
}

/* ===== UI ===== */
document.getElementById('btnStart').addEventListener('click', async ()=>{
  try {
    await startCamera(document.getElementById('deviceSelect').value || null);
    await fetchEmbeddings();
  } catch(e) { log('Start erro: ' + e.message); }
});

document.getElementById('deviceSelect').addEventListener('change', async (e)=>{
  await startCamera(e.target.value);
});

document.getElementById('btnFoto').addEventListener('click', async ()=>{
  const nome = document.getElementById('nome').value.trim();
  const rg = document.getElementById('rg').value.trim();
  const cpf = document.getElementById('cpf').value.trim();
  const cin = document.getElementById('cin').value.trim();
  const cadStatus = document.getElementById('cadStatus');

  if (!nome) { cadStatus.innerHTML = '<span class="err">Informe o nome completo.</span>'; return; }

  try {
    const fotoBase64 = takeSnapshot();
    const embedding = await computeEmbeddingFromVideo();
    if (!embedding) { cadStatus.innerHTML = '<span class="err">Não foi possível detectar o rosto.</span>'; return; }

    const resp = await saveCadastro({ nome, rg, cpf, cin, embedding, fotoBase64 });
    cadStatus.innerHTML = `<span class="ok">Cadastro salvo.</span>`;
    log('Cadastro salvo. FileId: ' + (resp.fileId||'') );
    await fetchEmbeddings();
  } catch(e) {
    cadStatus.innerHTML = `<span class="err">${e.message}</span>`;
    log('Cadastro erro: ' + e.message);
  }
});

(async function init(){
  try {
    await loadModels();
    if (!('mediaDevices' in navigator)) {
      document.getElementById('recStatus').innerHTML = '<span class="err">Navegador sem suporte a câmera.</span>';
      log('mediaDevices não suportado.');
    } else {
      await listDevices();
    }
  } catch(e) {
    document.getElementById('recStatus').innerHTML = `<span class="err">Falha ao iniciar: ${e.message}</span>`;
    log('Init erro: ' + e.message);
  }
})();
</script>
</body>
</html>
