<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reconhecimento Facial</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --ink:#e2e8f0; --muted:#94a3b8; --border:#334155;
    --accent:#06b6d4; --accent-ink:#001018; --btn:#0284c7; --btn-muted:#475569;
    --shadow:0 8px 32px rgba(0,0,0,.35); --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:500 15px/1.6 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 18px}
  h1{font-size:28px;margin:0 0 6px}
  .subtitle{color:var(--muted);font-weight:600;font-size:14px;margin-bottom:18px}
  .grid{display:grid;gap:14px}
  @media(min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} }
  label{display:block;font-weight:600;margin-bottom:6px}
  input,select,button,textarea{
    width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--border);
    background:#132036;color:var(--ink);outline:none
  }
  input::placeholder{color:#94a3b8}
  select{cursor:pointer}
  button{background:var(--btn);border:none;color:#fff;font-weight:700;cursor:pointer}
  button[disabled]{background:var(--btn-muted);cursor:not-allowed}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .btn-secondary{background:#0ea5e9}
  .btn-ghost{background:#1f2937}
  .oculto{display:none}
  .hint{color:var(--muted);font-size:12px}
  .section-title{font-size:18px;font-weight:800;margin-top:6px;margin-bottom:8px}
  .inline{display:flex;gap:10px;align-items:center}
  .inline > *{flex:1}
  video,canvas{width:100%;max-height:320px;border-radius:12px;background:#0b1220;border:1px dashed #334155}
  footer{color:#94a3b8;font-size:12px;margin-top:14px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="inline" style="justify-content:space-between;gap:12px">
      <div>
        <h1>Reconhecimento Facial</h1>
        <div class="subtitle">Front no GitHub Pages + API no Apps Script (Planilhas + Drive).</div>
      </div>
      <div class="subtitle" id="clock" aria-live="polite">--/--/---- — --:--:--</div>
    </div>

    <!-- CADASTRO -->
    <div class="section-title">Cadastro</div>
    <div class="grid grid-2">
      <div>
        <label for="nome">Nome completo</label>
        <input id="nome" type="text" placeholder="Nome completo" autocomplete="name" />
      </div>

      <div>
        <label for="tipoDoc">Tipo de Documento</label>
        <select id="tipoDoc">
          <option value="">Selecione</option>
          <option value="rg">RG</option>
          <option value="cpf">CPF</option>
          <option value="cin">CIN</option>
        </select>
      </div>

      <div id="campoRG" class="oculto">
        <label for="rg">RG</label>
        <input id="rg" type="text" placeholder="RG" inputmode="numeric" />
        <div class="hint">Ex.: 12.345.678-9</div>
      </div>

      <div id="campoCPF" class="oculto">
        <label for="cpf">CPF</label>
        <input id="cpf" type="text" placeholder="CPF" inputmode="numeric" />
        <div class="hint">Ex.: 123.456.789-09</div>
      </div>

      <div id="campoCIN" class="oculto">
        <label for="cin">CIN</label>
        <input id="cin" type="text" placeholder="CIN" inputmode="numeric" />
        <div class="hint">Somente números</div>
      </div>
    </div>

    <!-- CÂMERA -->
    <div class="section-title" style="margin-top:18px">Captura (câmera)</div>
    <div class="grid">
      <video id="preview" playsinline autoplay muted class="oculto"></video>
      <canvas id="snapshot" class="oculto"></canvas>

      <div class="inline">
        <div>
          <label for="videoDevice">Dispositivo de vídeo</label>
          <select id="videoDevice"></select>
        </div>
        <div>
          <label for="sens">Sensibilidade</label>
          <input type="range" id="sens" min="1" max="100" value="50" />
        </div>
      </div>

      <div class="btn-row">
        <button id="btnAtivar">Ativar câmera</button>
        <button id="btnParar" disabled>Parar</button>
        <button id="btnCameraT" class="btn-secondary">Câmera traseira</button>
        <button id="btnCapturar" class="btn-ghost">Capturar foto + salvar</button>
      </div>
    </div>

    <footer>
      Os dados são enviados via HTTPS para sua GAS-API. Configure CORS no Apps Script para permitir este domínio.
    </footer>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyiWtixyPNhraJnH1x7ACyxZkT0C0W-brX1_Udd02uDiROGldTN4rUechC2fTPgAvxdIw/exec"; // troque se necessário
const TZ = "America/Sao_Paulo";

/* =========================
   RELOGIO (data/hora em tempo real)
========================= */
function tickClock(){
  try{
    const fmt = new Intl.DateTimeFormat("pt-BR", {
      timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    });
    document.getElementById("clock").textContent =
      fmt.format(new Date()).replace(",", " —");
  }catch(e){
    // fallback simples
    document.getElementById("clock").textContent = new Date().toLocaleString("pt-BR");
  }
}
setInterval(tickClock, 1000); tickClock();

/* =========================
   FORM: exibir campos por tipo + MÁSCARAS
========================= */
const selectTipo = document.getElementById("tipoDoc");
const campos = {
  rg: document.getElementById("campoRG"),
  cpf: document.getElementById("campoCPF"),
  cin: document.getElementById("campoCIN"),
};
selectTipo.addEventListener("change", () => {
  Object.values(campos).forEach(c => c.classList.add("oculto"));
  const t = selectTipo.value;
  if (campos[t]) campos[t].classList.remove("oculto");
});

/* Máscara genérica (9 = dígito) */
function aplicarMascara(input, padrao){
  if(!input) return;
  input.addEventListener("input", () => {
    const numeros = input.value.replace(/\D/g,"");
    let j=0, out="";
    for(let i=0;i<padrao.length;i++){
      out += (padrao[i]==="9")
        ? (numeros[j] ?? "").toString(), j++
        : padrao[i];
      if(j > numeros.length) break;
    }
    input.value = out.replace(/undefined/g,"");
  });
}
aplicarMascara(document.getElementById("rg"),  "99.999.999-9");
aplicarMascara(document.getElementById("cpf"), "999.999.999-99");
aplicarMascara(document.getElementById("cin"), "99999999999"); // livre

/* Helper: somente dígitos para enviar ao backend */
const apenasDigitos = s => (s||"").replace(/\D/g,"");

/* =========================
   CÂMERA
========================= */
let stream = null;
const elVideo = document.getElementById("preview");
const elCanvas = document.getElementById("snapshot");
const selDevices = document.getElementById("videoDevice");

async function listarCameras(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  selDevices.innerHTML = "";
  devices.filter(d=>d.kind==="videoinput").forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d.deviceId; opt.textContent = d.label || `Câmera ${selDevices.length+1}`;
    selDevices.appendChild(opt);
  });
}

async function startCamera(deviceId){
  if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
  const constraints = { video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode: "user"} , audio:false };
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  elVideo.srcObject = stream;
  elVideo.classList.remove("oculto");
  elCanvas.classList.add("oculto");
  document.getElementById("btnParar").disabled = false;
}

function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  elVideo.classList.add("oculto");
  document.getElementById("btnParar").disabled = true;
}

function capture(){
  if(!elVideo.srcObject) return null;
  const w = elVideo.videoWidth || 640, h = elVideo.videoHeight || 480;
  elCanvas.width = w; elCanvas.height = h;
  const ctx = elCanvas.getContext("2d");
  ctx.drawImage(elVideo, 0, 0, w, h);
  elCanvas.classList.remove("oculto");
  return elCanvas.toDataURL("image/jpeg", 0.92); // base64
}

/* Botões */
document.getElementById("btnAtivar").addEventListener("click", async () => {
  await listarCameras();
  await startCamera(selDevices.value || undefined);
});
document.getElementById("btnParar").addEventListener("click", stopCamera);
document.getElementById("btnCameraT").addEventListener("click", async () => {
  if(stream){stream.getTracks().forEach(t=>t.stop());}
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
  elVideo.srcObject = stream;
  elVideo.classList.remove("oculto");
});
selDevices.addEventListener("change", () => startCamera(selDevices.value));

/* =========================
   ENVIAR DADOS + FOTO PARA GAS
========================= */
async function enviar(){
  const nome = document.getElementById("nome").value.trim();
  const tipo = selectTipo.value;
  const rg  = apenasDigitos(document.getElementById("rg").value);
  const cpf = apenasDigitos(document.getElementById("cpf").value);
  const cin = apenasDigitos(document.getElementById("cin").value);

  if(!nome){ alert("Informe o nome completo."); return; }
  if(!tipo){ alert("Selecione o tipo de documento."); return; }
  if(tipo==="rg"  && !rg ){ alert("Informe o RG.");  return; }
  if(tipo==="cpf" && !cpf){ alert("Informe o CPF."); return; }
  if(tipo==="cin" && !cin){ alert("Informe o CIN."); return; }

  const fotoBase64 = capture(); // pode ser null se não ativou a câmera
  const payload = {
    action: "salvarCadastro",
    nome, tipo, rg, cpf, cin,
    fotoBase64,  // "data:image/jpeg;base64,..."
    sensibilidade: Number(document.getElementById("sens").value),
    tsClient: new Date().toISOString()
  };

  try{
    const r = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
      mode: "cors",
    });
    const data = await r.json().catch(()=> ({}));
    if(r.ok){
      alert("Cadastro enviado com sucesso!");
    }else{
      console.error(data);
      alert("Falha ao enviar. Verifique a GAS-API.");
    }
  }catch(err){
    console.error(err);
    alert("Erro de rede ao enviar os dados.");
  }
}

/* Usa o botão "Capturar foto + salvar" como submit */
document.getElementById("btnCapturar").addEventListener("click", enviar);

/* Permissões iniciais (alguns navegadores escondem labels até ter permissão) */
if(navigator.mediaDevices?.getUserMedia){
  // nada obrigatório aqui; fluxo inicia ao clicar "Ativar câmera"
}
</script>
</body>
</html>