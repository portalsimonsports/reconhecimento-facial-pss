<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reconhecimento Facial</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --ink:#e2e8f0; --muted:#94a3b8; --border:#334155;
    --btn:#0284c7; --btn-muted:#475569; --shadow:0 8px 32px rgba(0,0,0,.35); --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:500 15px/1.6 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 18px}
  h1{font-size:28px;margin:0 0 6px}
  .subtitle{color:var(--muted);font-weight:600;font-size:14px;margin-bottom:18px}
  .grid{display:grid;gap:14px}
  @media(min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} }
  label{display:block;font-weight:600;margin-bottom:6px}
  input,select,button{
    width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
    background:#132036;color:var(--ink);outline:none
  }
  input::placeholder{color:#94a3b8}
  button{background:var(--btn);border:none;color:#fff;font-weight:700;cursor:pointer}
  button[disabled]{background:var(--btn-muted);cursor:not-allowed}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .oculto{display:none}
  video,canvas{width:100%;max-height:320px;border-radius:12px;background:#0b1220;border:1px dashed #334155}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
      <div>
        <h1>Reconhecimento Facial</h1>
        <div class="subtitle">Front no GitHub Pages + API no Apps Script (Planilhas + Drive).</div>
      </div>
      <div class="subtitle" id="clock" aria-live="polite">--/--/---- — --:--:--</div>
    </div>

    <h3 style="margin:8px 0 6px">Cadastro</h3>
    <div class="grid grid-2">
      <div>
        <label for="nome">Nome completo</label>
        <input id="nome" type="text" placeholder="Nome completo" autocomplete="name" />
      </div>

      <div>
        <label for="tipoDoc">Tipo de Documento</label>
        <select id="tipoDoc">
          <option value="">Selecione</option>
          <option value="rg" selected>RG</option>
          <option value="cpf">CPF</option>
          <option value="cin">CIN</option>
        </select>
      </div>

      <div id="campoRG" class="">
        <label for="rg">RG</label>
        <input id="rg" type="text" placeholder="12.345.678-9" inputmode="numeric" />
      </div>

      <div id="campoCPF" class="oculto">
        <label for="cpf">CPF</label>
        <input id="cpf" type="text" placeholder="123.456.789-09" inputmode="numeric" />
      </div>

      <div id="campoCIN" class="oculto">
        <label for="cin">CIN</label>
        <input id="cin" type="text" placeholder="Somente números" inputmode="numeric" />
      </div>
    </div>

    <h3 style="margin:18px 0 6px">Captura (câmera)</h3>
    <div class="grid">
      <video id="preview" playsinline autoplay muted class="oculto"></video>
      <canvas id="snapshot" class="oculto"></canvas>

      <div style="display:flex;gap:10px;align-items:center">
        <div style="flex:1">
          <label for="videoDevice">Dispositivo de vídeo</label>
          <select id="videoDevice"></select>
        </div>
        <div style="flex:1">
          <label for="sens">Sensibilidade</label>
          <input type="range" id="sens" min="1" max="100" value="50" />
        </div>
      </div>

      <div class="btn-row">
        <button id="btnAtivar">Ativar câmera</button>
        <button id="btnParar" disabled>Parar</button>
        <button id="btnCameraT">Câmera traseira</button>
        <button id="btnCapturar">Capturar foto + salvar</button>
      </div>
    </div>
  </div>
</div>

<script defer>
/*** CONFIG ***/
const API_URL = "https://script.google.com/macros/s/AKfycbyiWtixyPNhraJnH1x7ACyxZkT0C0W-brX1_Udd02uDiROGldTN4rUechC2fTPgAvxdIw/exec";
const TZ = "America/Sao_Paulo";

/*** RELOGIO ***/
function tickClock(){
  try{
    const f = new Intl.DateTimeFormat("pt-BR", {timeZone:TZ,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
    document.getElementById("clock").textContent = f.format(new Date()).replace(",", " —");
  }catch(_){
    document.getElementById("clock").textContent = new Date().toLocaleString("pt-BR");
  }
}

/*** DOC CAMPOS + MÁSCARAS ***/
const selectTipo = document.getElementById("tipoDoc");
const campos = {
  rg:  document.getElementById("campoRG"),
  cpf: document.getElementById("campoCPF"),
  cin: document.getElementById("campoCIN"),
};
function updateDocFields(){
  Object.values(campos).forEach(c=>c.classList.add("oculto"));
  const t = selectTipo.value;
  if (campos[t]) campos[t].classList.remove("oculto");
}
function aplicarMascara(input, padrao){
  if(!input) return;
  input.addEventListener("input", ()=>{
    const nums = input.value.replace(/\D/g,"");
    let j=0, out="";
    for(let i=0;i<padrao.length;i++){
      out += (padrao[i]==="9") ? (nums[j++] ?? "") : padrao[i];
      if(j>nums.length) break;
    }
    input.value = out.replace(/undefined/g,"");
  });
}

/*** CÂMERA ***/
let stream=null;
const elVideo = document.getElementById("preview");
const elCanvas= document.getElementById("snapshot");
const selDevices=document.getElementById("videoDevice");

async function garantirPermissaoCamera(){
  // Necessário em muitos navegadores para liberar enumerateDevices com labels
  try{
    if (!stream){
      stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      stream.getTracks().forEach(t=>t.stop()); // apenas para desbloquear
      stream=null;
    }
    return true;
  }catch(e){
    alert("Permita o acesso à câmera para continuar.");
    console.error(e);
    return false;
  }
}
async function listarCameras(){
  const devs = await navigator.mediaDevices.enumerateDevices();
  selDevices.innerHTML = "";
  devs.filter(d=>d.kind==="videoinput").forEach((d,i)=>{
    const o=document.createElement("option");
    o.value=d.deviceId; o.textContent=d.label||`Câmera ${i+1}`;
    selDevices.appendChild(o);
  });
}
async function startCamera(deviceId, facingMode){
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    const constraints = facingMode
      ? {video:{facingMode}, audio:false}
      : deviceId ? {video:{deviceId:{exact:deviceId}}, audio:false}
                 : {video:true, audio:false};
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    elVideo.srcObject = stream;
    elVideo.classList.remove("oculto");
    elCanvas.classList.add("oculto");
    document.getElementById("btnParar").disabled=false;
  }catch(e){
    console.error(e);
    alert("Não foi possível iniciar a câmera.");
  }
}
function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  elVideo.classList.add("oculto");
  document.getElementById("btnParar").disabled=true;
}
function capture(){
  if(!elVideo.srcObject) return null;
  const w=elVideo.videoWidth||640,h=elVideo.videoHeight||480;
  elCanvas.width=w; elCanvas.height=h;
  const ctx=elCanvas.getContext("2d"); ctx.drawImage(elVideo,0,0,w,h);
  elCanvas.classList.remove("oculto");
  return elCanvas.toDataURL("image/jpeg",0.92);
}

/*** ENVIAR ***/
const soDigitos = s => (s||"").replace(/\D/g,"");
async function enviar(){
  const nome=document.getElementById("nome").value.trim();
  const tipo=selectTipo.value;
  const rg = soDigitos(document.getElementById("rg").value);
  const cpf= soDigitos(document.getElementById("cpf").value);
  const cin= soDigitos(document.getElementById("cin").value);
  if(!nome) return alert("Informe o nome completo.");
  if(!tipo) return alert("Selecione o tipo de documento.");
  if(tipo==="rg" && !rg)  return alert("Informe o RG.");
  if(tipo==="cpf"&& !cpf) return alert("Informe o CPF.");
  if(tipo==="cin"&& !cin) return alert("Informe o CIN.");

  const fotoBase64 = capture();
  try{
    const r = await fetch(API_URL, {method:"POST",headers:{"Content-Type":"application/json"},
      body: JSON.stringify({action:"salvarCadastro",nome,tipo,rg,cpf,cin,fotoBase64,tsClient:new Date().toISOString()}),
      mode:"cors"
    });
    if(!r.ok) throw new Error("HTTP "+r.status);
    alert("Cadastro enviado com sucesso!");
  }catch(e){
    console.error(e); alert("Falha ao enviar. Verifique a GAS-API.");
  }
}

/*** BIND DE BOTÕES ***/
function bind(){
  document.getElementById("btnAtivar").addEventListener("click", async ()=>{
    const ok = await garantirPermissaoCamera();
    if(ok){ await listarCameras(); await startCamera(selDevices.value||undefined); }
  });
  document.getElementById("btnParar").addEventListener("click", stopCamera);
  document.getElementById("btnCameraT").addEventListener("click", async ()=>{
    const ok = await garantirPermissaoCamera();
    if(ok) await startCamera(null,"environment");
  });
  document.getElementById("btnCapturar").addEventListener("click", enviar);
  selDevices.addEventListener("change", ()=> startCamera(selDevices.value));
  selectTipo.addEventListener("change", updateDocFields);
}

/*** INIT (garante tudo rodando após o DOM estar pronto) ***/
async function init(){
  tickClock(); setInterval(tickClock, 1000);

  // máscaras
  aplicarMascara(document.getElementById("rg"),  "99.999.999-9");
  aplicarMascara(document.getElementById("cpf"), "999.999.999-99");
  aplicarMascara(document.getElementById("cin"), "99999999999");

  // exibe o campo do doc correspondente ao valor atual do select
  updateDocFields();

  // prepara câmera (pede permissão para liberar enumerateDevices)
  await garantirPermissaoCamera();
  await listarCameras();

  bind();
}

// dispara quando o HTML já está parseado
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>